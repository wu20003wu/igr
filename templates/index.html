<!DOCTYPE html>
<html>
<head>
  <title>Routen-Highlight bei Klick</title>
  <script src="../static/js/cytoscape.min.js"></script>
  <style>
    #cy {
      width: 800px;
      height: 600px;
      border: 1px solid #ccc;
      margin: 20px auto;
    }
    #statsPanel {
      background: #f9f9f9;
      border-radius: 4px;
    }
    .highlight-rule {
      background-color: #fff3d0;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
      position: relative;
    }
    .highlight-rule::after {
      content: "➤";
      color: #ffd700;
      position: absolute;
      right: 10px;
    }
    #recenterBtn {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 1000;
      background: #0074D9;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    #recenterBtn:hover {
      background: #0056b3;
      transform: scale(1.1);
    }
    #recenterBtn:active {
      transform: scale(0.95);
    }
    .message-form button:hover {
      background: #0056b3;
    }
    .message-form select:focus,
    .message-form input:focus {
      outline: none;
      border-color: #0074D9;
      box-shadow: 0 0 0 2px rgba(0,116,217,0.2);
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: center; align-items: flex-start; gap: 20px; margin: 20px;">
    <!-- Statistik-Panel -->
    <!--
    <div id="statsPanel" style="width: 200px; border: 1px solid #ccc; padding: 10px;">
      <div style="margin-bottom: 10px;">
        <input type="datetime-local" id="startTime" step="1" style="width: 100%;">
      </div>
      <button id="monitorButton" onclick="toggleMonitoring()" style="width: 100%;">Monitoring starten</button>
      <div id="stats" style="margin-top: 10px; font-size: 12px;"></div>
    </div>
    -->

    <!-- Cytoscape Diagramm -->
    <div id="cy" style="width: 100vw; height: 100vh; border: 1px solid #ccc;"></div>
  </div>

  <!-- Füge nach dem cy div und vor der Tabelle ein -->
  <div style="margin: 20px auto; width: 80%; background: #f8f9fa; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <form id="messageForm" class="message-form">
      <div style="margin-bottom: 15px;">
        <label for="message" style="display: block; margin-bottom: 5px; font-weight: bold;">Message:</label>
        <input type="text" id="message" name="message" 
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
               placeholder="Gib deine Nachricht ein..."
               required>
      </div>
    </form>
  </div>

  <!-- Add after the cytoscape div -->
  <div style="margin: 20px auto; width: 80%;">
    <h3>Routing Rules Table</h3>
    <table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%; margin-top: 20px;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th>Order</th>
                <th>Queue Name</th>
                <th>Rule</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in all_rules %}
            <tr class="rule-row" data-order="{{ rule.rule_order }}">
                <td>{{ rule.rule_order }}</td>
                <td>{{ rule.queue_name }}</td>
                <td>{{ rule.rule }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
  </div>

  <!-- Füge diesen Code innerhalb des body-Tags hinzu, vor dem cytoscape div -->
  <button id="recenterBtn" title="Zentrieren und zoomen">
    <svg width="24" height="24" viewBox="0 0 24 24" style="vertical-align: middle;">
      <path fill="currentColor" d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4Z"/>
    </svg>
  </button>

  <script>
    const cy = cytoscape({
      container: document.getElementById('cy'),

      elements: [
        // Knoten aus der Datenbank
        // Change the node rendering to:
        {% for node in nodes | sort(attribute='link_name') %}
          { data: { id: '{{ node.link_name }}' } },
        {% endfor %}
        
        // Manuell hinzugefügter Router-Knoten
        { data: { id: 'Router' } },

        // Kanten aus der Datenbank
        {% for edge in edges %}
        {
          data: {
            id: '{{ edge.id }}',
            source: '{{ edge.source }}',
            target: '{{ edge.target }}',
            label: '{{ edge.label }}'
          }
        },
        {% endfor %}
      ],

      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(id)',
            'background-color': '#FFFFFF',
            'border-color': '#0074D9',
            'border-width': 1,
            'color': '#0074D9',
            'text-valign': 'center',
            'text-halign': 'center',
            'width': 200,
            'height': 200,
            'font-size': 80
          }
        },
        {
          selector: 'node[id="Router"]',
          style: {
            'background-color': '#FF4136',
            'shape': 'hexagon',
            'label': 'IGT'
          }
        },
        {
          selector: 'edge',
          style: {
            'label': 'data(label)',
            'font-size': 80,
            'text-rotation': 'autorotate',
            'width': 3,
            'line-color': '#aaa',
            'curve-style': 'unbundled-bezier',
            'control-point-distances': [70, -70],  // Increase the distances for more curvature
            'text-outline-color': '#fff',
            'text-outline-width': 2,
            // 'mid-source-arrow-shape': 'diamond',     // Shape at the midpoint closer to the target
            'mid-source-arrow-color': '#f00',        // Color of the midpoint arrow closer to the target
            'mid-target-arrow-shape': 'vee',         // Shape at the midpoint closer to the source
            'mid-target-arrow-color': '#00f',         // Color of the midpoint arrow closer to the source
            'control-point-weights': [0.8],           // Adjust the control point weight to move the mid-arrow
            'arrow-scale': 3,  // Scale all arrow shapes by 2
          }
        },
        {
          selector: '.highlight-in',
          style: {
            'line-color': 'red',
            'target-arrow-color': 'red',
            'width': 5
          }
        },
        {
          selector: '.highlight-out',
          style: {
            'line-color': 'green',
            'target-arrow-color': 'green',
            'width': 5
          }
        }
      ],

      layout: {
        name: 'concentric',
        concentric: node => node.id() === 'Router' ? 2 : 1,
        levelWidth: () => 1,
        spacingFactor: 2
      }
    });

    // Routing-Regeln (Eingehend)
    const routingRules = {
      {% for in_link, queues in routing_rules.items() %}
        "{{ in_link }}": [{{ queues|map('tojson')|join(', ') }}],
      {% endfor %}
    };

    // Reverse-Regeln (Ausgehend)
    const reverseRoutingRules = {
      {% for queue, origins in reverse_routing_rules.items() %}
        "{{ queue }}": [{{ origins|map('tojson')|join(', ') }}],
      {% endfor %}
    };

    function validateRule(ruleObj, message, inLink) {
      const ruleString = ruleObj.rule || '';
      console.log('Processing rule string:', ruleString);
      const conditions = ruleString
        .replace(/IN_LINK\s*=\s*"([^"]*)"/g, (match, value) => `'${inLink}' === '${value}'`)
        .replace(/IN_LINK\s+LIKE\s*"([^"]*)"/g, (match, pattern) => {
          const regexPattern = pattern.replace(/\*/g, '.*');
          return `new RegExp('^${regexPattern}$').test('${inLink}')`;
        })
        .replace(/MESSAGE\s+LIKE\s*"([^"]*)"/g, (match, pattern) => {
          const regexPattern = pattern.replace(/\*/g, '.*');
          console.log('Converted MESSAGE LIKE pattern to regex:', regexPattern);
          const regex = new RegExp(`^${regexPattern}$`);
          const matchResult = regex.test(message);
          console.log('Testing message against regex:', message, 'Result:', matchResult);
          return matchResult;
        })
        // Add these replacements for logical operators
        .replace(/\bAND\b/g, '&&')
        .replace(/\bOR\b/g, '||');

      console.log('Evaluating conditions:', conditions);
      console.log('Message:', message, 'InLink:', inLink);

      try {
        const result = conditions ? eval(conditions) : false;
        console.log('Validation result:', result);
        return result;
      } catch (error) {
        console.error('Error evaluating conditions:', error);
        return false;
      }
    }

    cy.on('tap', 'edge', function(evt) {
      const message = document.getElementById('message').value;
      // Originale Highlight-Logik
      cy.edges().removeClass('highlight-in highlight-out').data('label', '');
      const clickedEdge = evt.target;
      const sourceNode = clickedEdge.data('source');
      const targetNode = clickedEdge.data('target');

      console.log('Clicked edge:', sourceNode, 'to', targetNode);

      if (sourceNode === 'Router') {
        // OUTLINK: Router → X
        const targetLink = targetNode;
        const rules = reverseRoutingRules[targetLink] || [];

        console.log('Reverse rules for target link:', targetLink, rules);

        clickedEdge.addClass('highlight-out').data('label', Array.from(new Set(rules.map(r => r.order))).join(', '));

        rules.forEach(rule => {
            const edgeId = `${rule.source}_to_Router`;
            const originEdge = cy.getElementById(edgeId);
            if (originEdge.length) {
                originEdge.addClass('highlight-in')
                    .data('label', rule.order);
            }
        });

      } else {
        // INLINK: X → Router
        const rules = routingRules[sourceNode] || [];
        console.log('Rules for source node:', sourceNode, rules);

        const validRules = message.trim() === '' 
          ? rules  // Use all rules when message is empty
          : rules.filter(rule => validateRule(rule, message, sourceNode));

        console.log('Valid rules after filtering:', validRules);

        clickedEdge.addClass('highlight-in').data('label', 
          Array.from(new Set(validRules.map(r => r.order))).join(', ')
        );

        validRules.forEach(rule => {
            const edgeId = `Router_to_${rule.target}`;
            const targetEdge = cy.getElementById(edgeId);
            if (targetEdge.length) {
                targetEdge.addClass('highlight-out')
                    .data('label', rule.order);
            }
        });
      }
      
      // Neue Tabellen-Highlight-Logik
      const edgeLabel = clickedEdge.data('label');
      const ruleOrders = edgeLabel.split(',').map(Number).filter(n => !isNaN(n));
      
      document.querySelectorAll('.rule-row').forEach(row => {
        row.classList.remove('highlight-rule');
        if (ruleOrders.includes(Number(row.dataset.order))) {
          row.classList.add('highlight-rule');
        }
      });
      
      cy.style().update();
    });

    // Füge diesen Code zum bestehenden Script hinzu
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#cy') && !e.target.closest('.rules-table')) {
        cy.edges().removeClass('highlight-in highlight-out');
        document.querySelectorAll('.rule-row').forEach(row => {
          row.classList.remove('highlight-rule');
        });
      }
    });

    // Füge diesen Code zum bestehenden Script hinzu
    document.getElementById('recenterBtn').addEventListener('click', function() {
      cy.animate({
        fit: {
          padding: 100,
          nodes: cy.nodes()
        },
        center: {
          nodes: cy.nodes()
        },
        zoom: 0.8,
        duration: 500
      });

      // Zurücksetzen aller Visuals
      cy.elements()
        .removeClass('highlight-in highlight-out')
        .data('label', ''); // Edge-Labels leeren

      document.querySelectorAll('.rule-row').forEach(row => {
        row.classList.remove('highlight-rule');
      });
    });

    // Füge zum bestehenden Script hinzu
    document.getElementById('messageForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const message = document.getElementById('message').value;
      
      if (!message) {
        alert('Bitte gib eine Nachricht ein');
        return;
      }

      console.log('Sending:', { message });
      // Hier später die Logik für das Senden der Nachricht
    });
  </script>
</body>
</html>
